---
created: 2024-01-14T11:25:28 (UTC +10:00)
tags: []
source: https://interface31.ru/tech_it/2019/10/nastraivaem-set-v-proxmox-ve.html
author: 
---

# Настраиваем сеть в Proxmox Virtual Environment - Записки IT специалиста

> ## Excerpt
> Настройка сетевой конфигурации системы виртуализации - одна из самых главных задач, она же вызывает наибольшие затруднения у начинающих. Поэтому начиная цикл статей о Proxmox мы сразу решили подробно разобрать этот вопрос. Тем более, что официальная документация довольно скупо освещает эту...

---
![PVE-network-configuration-000.png](https://interface31.ru/tech_it/images/PVE-network-configuration-000.png)Настройка сетевой конфигурации системы виртуализации - одна из самых главных задач, она же вызывает наибольшие затруднения у начинающих. Поэтому начиная цикл статей о Proxmox мы сразу решили подробно разобрать этот вопрос. Тем более, что официальная документация довольно скупо освещает эту тему и может сложиться впечатление, что Proxmox ограничен в сетевых возможностях по сравнению с другими гипервизорами. Однако это не так, скорее даже наоборот, потому что перед нами открытое ПО и мы можем конфигурировать его именно так, как считаем нужным, даже если этих возможностей не было из коробки.

Научиться настраивать MikroTik с нуля или систематизировать уже имеющиеся знания можно на [углубленном курсе по администрированию MikroTik](https://xn-----xlcfvffioc4g.xn--p1ai/lp-mikrotik-mtcna?utm_source=interface31&utm_medium=cpc&utm_campaign=20-1205). Автор курса, сертифицированный тренер MikroTik Дмитрий Скоромнов, лично проверяет лабораторные работы и контролирует прогресс каждого своего студента. В три раза больше информации, чем в вендорской программе MTCNA, более 20 часов практики и доступ навсегда.

Если обратиться к [официальной документации](https://pve.proxmox.com/wiki/Network_Configuration), то там будет рассказано о двух основных сетевых конфигурациях: с использованием моста и маршрутизации. Приведенные примеры покрывают основные сценарии использования и не углубляются в подробности, но различные комбинации настроек для этих вариантов позволяют реализовывать самые разнообразные сетевые конфигурации. В данном материале мы рассмотрим базовые возможности Proxmox, не касаясь объединения сетевых адаптеров или использования Open vSwitch, потому как это отдельные темы, лежащие за рамками базовой настройки.

Все сетевые параметры настраиваются на уровне ноды, для этого перейдите на нужный сервер и раскройте **Система - Сеть**. Ниже показан пример нашего тестового сервера, где реализованы все те сетевые конфигурации, о которых мы будем говорить ниже.

### [![PVE-network-configuration-001.png](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-001-thumb-600xauto-10473.png)](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-001-10473.html)

### Внешняя сеть

Сетевая конфигурация, создаваемая по умолчанию, когда и виртуальные машины, и гипервизор получают прозрачный доступ к вешней сети, подключенной через физический сетевой адаптер. Она же самая часто используемая, так как позволяет организовать ==простой доступ к виртуальным машинам, как к самым обычным узлам локальной сети==.

![PVE-network-configuration-002.png](https://interface31.ru/tech_it/images/PVE-network-configuration-002.png)В основе всех виртуальных сетей в Proxmoх лежит ==**сетевой мост** (_Linux Bridge_) - **vmbr**==, допускается создание до 4095 таких устройств. Сетевой мост может включать в себя как физические, так и виртуальные адаптеры, выполняя для них ==роль неуправляемого коммутатора==. ==Физическая сетевая карта, подключенная к мосту, не имеет настроек и используется как физический Ehternet-интерфейс для данного виртуального коммутатора==. Все сетевые настройки производятся внутри виртуальных машин, которые через мост и физический адаптер прозрачно попадают во внешнюю сеть.

Присвоение интерфейсу моста IP-адреса фактически подключает к виртуальному коммутатору сам хост, т.е. гипервизор, который также прозрачно попадет во внешнюю сеть. Если в Hyper-V для подключения гипервизора к сети на хосте создавался еще один виртуальный сетевой адаптер, то в Proxmox для этого следует назначить IP-адрес интерфейсу моста. Ниже показан пример такой настройки:

![PVE-network-configuration-003.png](https://interface31.ru/tech_it/images/PVE-network-configuration-003.png)В настройках указывается адрес и шлюз, опция автозапуска и привязанный к мосту физический адаптер. Также мы советуем в поле комментарий оставлять осмысленное описание сетевого устройства, чтобы всегда было понятно, что это и зачем.

Фактически это сетевые настройки самого гипервизора. Обратите внимание, что сервера DNS указываются отдельно, в **Система - DNS**:

[![PVE-network-configuration-004.png](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-004-thumb-600xauto-10478.png)](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-004-10478.html)Для того, чтобы подключить к такой сети виртуальную машину в настройках ее сетевого адаптера следует выбрать нужный мост (виртуальный коммутатор):

[![PVE-network-configuration-005.png](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-005-thumb-600xauto-10481.png)](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-005-10481.html)Сетевые настройки виртуальной машины либо задаются вручную, либо могут быть получены от DHCP-сервера внешней сети.

### Внешняя изолированная сеть

Данная конфигурация требует минимум двух сетевых адаптеров и предусматривает изоляцию гипервизора от внешней сети и виртуальных машин. Это может быть полезно при виртуализации пограничных устройства, например, шлюза. Либо когда виртуальные машины арендуются третьими лицами, либо находятся вне доверенной сети и доступ к гипервизору оттуда должен быть закрыт.

![PVE-network-configuration-006.png](https://interface31.ru/tech_it/images/PVE-network-configuration-006.png)Для создания изолированной внешней сети нам потребуется создать новый сетевой мост без сетевых настроек и привязать к нему физический адаптер (тоже без настроек), таким образом будет обеспечен доступ виртуальных машин во внешнюю сеть с изоляцией этой сети от гипервизора.

![PVE-network-configuration-007.png](https://interface31.ru/tech_it/images/PVE-network-configuration-007.png)Для доступа к самому гипервизору может быть использован либо другой сетевой адаптер (как показано на нашей схеме), так и созданная по умолчанию внешняя сеть с сетевым мостом. Оба варианта имеют право на жизнь, а во втором случае вы сможете также подключать виртуальные машины к разным виртуальным сетям. Поэтому не следует рассматривать приведенную нами схему как догму, это только один из возможных вариантов и выбран нами в целях упрощения схемы.

Для примера мы подключили к такой сети виртуальную машину, которая тут же получила по DHCP адрес из внешней сети, никак не связанной с гипервизором.

 [![PVE-network-configuration-008.png](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-008-thumb-600xauto-10486.png)](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-008-10486.html)
### Внутренняя сеть с NAT

Применяется в тех случаях, когда нужно изолировать виртуальные машины в собственной сети, но в тоже время обеспечить им доступ в интернет, а также доступ из внешней сети к некоторым из них (или отдельным сетевым службам). Широко используется в лабораторных сценариях, а также при работе с контейнерами.

![PVE-network-configuration-009.png](https://interface31.ru/tech_it/images/PVE-network-configuration-009.png)Обратите внимание, данная конфигурация не может быть изолирована от хоста, так как именно хост предоставляет ей службу **трансляции сетевых адресов** (NAT) и выступает шлюзом для виртуальных машин. Для настройки такой сети создайте новый сетевой мост без привязки к физическому адаптеру и назначьте ему IP-адрес из произвольной сети, отличной от внешней.

![PVE-network-configuration-010.png](https://interface31.ru/tech_it/images/PVE-network-configuration-010.png)Все изменения сетевой конфигурации требуют перезагрузки узла гипервизора, поэтому, чтобы не перезагружать узел дважды перейдем в консоль сервера и перейдем в директорию **/etc/network**, в котором будут присутствовать файлы **interfaces** - с текущей сетевой конфигурацией и **interfaces.new** - с новой, которая вступит в силу после перезагрузки.

[![PVE-network-configuration-011.png](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-011-thumb-600xauto-10493.png)](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-011-10493.html)Откроем именно **interfaces.new** и внесем в конец следующие строки:

```
<span>post</span>-up echo <span>1</span> &gt; /proc/sys/net/ipv<span>4</span>/ip_forward<br>post-up   iptables -t nat -A POSTROUTING -s '<span>192.168.34.0</span>/<span>24</span>' -o ens<span>33</span> -j MASQUERADE<br>post-down iptables -t nat -D POSTROUTING -s '<span>192.168.34.0</span>/<span>24</span>' -o ens<span>33</span> -j MASQUERADE
```

В качестве сети, в нашем случае **192.168.34.0/24**, укажите выбранную вами сеть, а вместо интерфейса **ens33** укажите тот сетевой интерфейс, который смотрит во внешнюю сеть с доступом в интернет. Если вы используете сетевую конфигурацию по умолчанию, то это будет не физический адаптер, а первый созданный мост **vmbr0**, как на скриншоте ниже:

[![PVE-network-configuration-012.png](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-012-thumb-600xauto-10496.png)](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-012-10496.html)Перезагрузим узел и назначим виртуальной машине или контейнеру созданную сеть (vmbr1), также выдадим ей адрес из этой сети, а шлюзом укажем адрес моста.

![PVE-network-configuration-013.png](https://interface31.ru/tech_it/images/PVE-network-configuration-013.png)

Не забудьте указать доступный адрес DNS-сервера и убедитесь, что виртуальная машина имеет выход в интернет через NAT.

### Внутренняя сеть

Позволяет изолировать виртуальные машины от внешней сети и не предоставляет им доступ в интернет, используется в основном в лабораторных целях, когда в качестве шлюза будет выступать одна из виртуальных машин и обычно сочетается на хосте с одной из сетей, имеющих выход в интернет.

![PVE-network-configuration-014.png](https://interface31.ru/tech_it/images/PVE-network-configuration-014.png)

Чтобы получить такую сеть, просто создайте еще один мост без привязки к адаптеру и назначьте ему IP-адрес из любой отличной от используемых сети.

![PVE-network-configuration-015.png](https://interface31.ru/tech_it/images/PVE-network-configuration-015.png)
### Частная сеть

Разновидность внутренней сети, которая подразумевает изоляцию не только от внешней сети, но и от хоста. Что позволяет получить полностью независимую сеть между виртуальными машинами, может быть полезна в лабораторных условиях, когда нужно смоделировать сеть, адресация которой пересекается с используемыми вами сетями.

![PVE-network-configuration-016.png](https://interface31.ru/tech_it/images/PVE-network-configuration-016.png)Для такой сети просто создайте еще один сетевой мост без каких-либо настроек:

[![PVE-network-configuration-017.png](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-017-thumb-600x247-10505.png)](https://interface31.ru/tech_it/assets_c/2019/10/PVE-network-configuration-017-10505.html)Подобные сети также обычно используются не самостоятельно, а в сочетании с иными типами сетей на хосте.

### Организуем службы DNS и DHCP для внутренних сетей

Как вы уже могли заметить все адреса для виртуальных машин во внутренних сетях мы назначали вручную. Но можно это делать автоматически, сняв с себя еще одну заботу, это удобно, особенно в лабораторных и тестовых средах, где виртуальных машин много и назначать им адреса вручную может быть достаточно затруднительно.

В нашем примере мы организуем службы DNS и DHCP для внутренней сети с NAT и просто внутренней сети. Для первой мы должны будет выдавать адрес, шлюз и сервера DNS, для второй просто адрес. Данная конфигурация не является реальной, а создана нами исключительно в учебных целях.

В качестве серверов DNS и DHCP мы будем использовать уже известный нашим читателям пакет **dnsmasq**, который является простым и легким кеширующим DNS и DHCP-сервером. Установим его:

```
<span>apt</span> install dnsmasq
```

Затем перейдем в конфигурационный файл **/etc/dnsmasq.conf** и найдем и приведем к следующему виду параметры:

```
<span>interface</span>= vmbrl, vmbr<span>2</span><br>listen-address= <span>127.0.0.1</span>, <span>192.168.34.2</span>, <span>192.168.35.2</span>
```

Здесь мы явно указали интерфейсы и адреса, на которых будет работать наш сервер. С одной стороны, присутствует некоторая избыточность, но лучше так, чем потом, при изменении сетевых настроек в вашей сети неожиданно появится неавторизованный DHCP-сервер.

Затем укажем выдаваемые клиентам диапазоны адресов:

```
<span>dhcp</span>-range=interface:vmbr<span>1</span>,<span>192.168.34.101</span>,<span>192.168.34.199</span>,<span>255.255.255.0</span>,<span>12</span>h<br>dhcp-range=interface:vmbr<span>2</span>,<span>192.168.35.101</span>,<span>192.168.35.199</span>,<span>255.255.255.0</span>,<span>12</span>h
```

Обратите внимание на формат записи, перед каждой настройкой мы указываем сетевой интерфейс к которой она применяется.

Аналогичным образом зададим нужные DHCP-опции, в нашем случае это Option 3 и 6 (шлюз и DNS-сервер).

```
<span>dhcp</span>-option=interface:vmbr<span>1</span>,<span>3</span>,<span>192.168.34.2</span><br>dhcp-option=interface:vmbr<span>1</span>,<span>6</span>,<span>192.168.34.2</span><br>dhcp-option=interface:vmbr<span>2</span>,<span>3</span><br>dhcp-option=interface:vmbr<span>2</span>,<span>6</span>
```

Если настройки для моста **vmbr1** не вызывают вопросов, то настройки для второй сети следует пояснить. Так как нам нужно передавать ей только IP-адрес и маску, без шлюза и серверов имен, то соответствующие опции следует передать пустыми, иначе будут переданы опции по умолчанию, где в качестве этих узлов будет передан адрес сервера.

Сохраняем конфигурационный файл и перезапускаем службу

```
<span>service</span> dnsmasq restart
```

После чего в виртуальных машинах, подключенных к внутренним сетям, мы можем установить настройки для получения адреса через DHCP и убедиться, что все работает как надо.

Научиться настраивать MikroTik с нуля или систематизировать уже имеющиеся знания можно на [углубленном курсе по администрированию MikroTik](https://xn-----xlcfvffioc4g.xn--p1ai/lp-mikrotik-mtcna?utm_source=interface31&utm_medium=cpc&utm_campaign=20-1205). Автор курса, сертифицированный тренер MikroTik Дмитрий Скоромнов, лично проверяет лабораторные работы и контролирует прогресс каждого своего студента. В три раза больше информации, чем в вендорской программе MTCNA, более 20 часов практики и доступ навсегда.
